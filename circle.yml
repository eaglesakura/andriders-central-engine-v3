checkout:
  post:
    - chmod 755 ./gradlew
    - chmod 755 ./script/circleci-invalidate-cache.sh
    - chmod 755 ./script/circleci-build-assemble.sh
    - chmod 755 ./script/circleci-build-testing.sh
    - chmod 755 ./script/circleci-deploy-deploygate.sh
    - chmod 755 ./script/developer-install-private.sh
    - git submodule update --init
machine:
  timezone:
    Asia/Tokyo
  java:
    version: oraclejdk8
  environment:
    ANDROID_HOME: /home/ubuntu/android-sdk
    BUILD_CACHEDIR: /home/ubuntu/build-cache
    GRADLE_OPTS: -Dorg.gradle.parallel=false -Dorg.gradle.daemon=false -Dorg.gradle.jvmargs="-Xmx1024m -XX:MaxPermSize=512m -XX:+HeapDumpOnOutOfMemoryError"
    JAVA_OPTS: -Dfile.encoding=UTF-8 -Xms512m -Xmx1024m -XX:MaxPermSize=512m
dependencies:
  cache_directories:
    - "/home/ubuntu/android-sdk"
    - "/home/ubuntu/build-cache"
  override:
    - sh -c "$(curl -fsSL https://raw.githubusercontent.com/eaglesakura/build-dependencies/master/circleci/install-android-sdk.sh)"
    - ./script/developer-install-private.sh
    - ./gradlew --refresh-dependencies -Dorg.gradle.parallel=false -Dorg.gradle.jvmargs="-Xms512m -Xmx512m" -Dorg.gradle.daemon=false :app:dependencies
test:
  override:
      - ./script/circleci-build-assemble.sh
      - ./gradlew -PpreDexEnable=false -Pcom.android.build.threadPoolSize=1 -Dorg.gradle.parallel=false -Dorg.gradle.daemon=false -Dorg.gradle.jvmargs="-Xmx1024m -XX:MaxPermSize=512m -XX:+HeapDumpOnOutOfMemoryError" :app:testGoogleplayDebugUnitTest
#      - ./script/circleci-build-testing.sh
deployment:
  feature:
    branch: /^feature\/id\/.*$/
    commands:
      - cp -r ./ci-release $CIRCLE_ARTIFACTS
  develop:
    branch: develop
    commands:
      - ./gradlew :app:dependencyUpdates
      - ./script/circleci-deploy-deploygate.sh
      - cp -r ./ci-release $CIRCLE_ARTIFACTS
  nightly:
    branch: master
    commands:
      - ./gradlew :app:dependencyUpdates
      - cp -r ./ci-release $CIRCLE_ARTIFACTS
  release:
    branch: /^v[0-9]\..*$/
    commands:
      - ./gradlew :app:dependencyUpdates
      - ./script/circleci-deploy-deploygate.sh
      - cp -r ./ci-release $CIRCLE_ARTIFACTS
